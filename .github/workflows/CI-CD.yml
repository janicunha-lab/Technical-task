name: CI/CD

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - 'Production'
          - 'Sandbox'
      directCommit:
        description: 'Direct commit (no PR)'
        required: false
        type: boolean
        default: false
  push:
    branches:
      - main

jobs:
  CI-CD:
    name: CI/CD
    runs-on: windows-latest
    permissions:
      contents: write
      pull-requests: write
      checks: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install BcContainerHelper
        shell: pwsh
        run: |
          Install-Module BcContainerHelper -Force -Scope CurrentUser -AllowClobber

      - name: Run CI/CD Pipeline
        shell: pwsh
        env:
          ENVIRONMENT: ${{ github.event.inputs.environment }}
          DIRECTCOMMIT: ${{ github.event.inputs.directCommit }}
          BcContainerHelperTelemetryConnectionString: ""
        run: |
          $ErrorActionPreference = "Stop"
          
          # Disable telemetry
          $env:BcContainerHelperTelemetryConnectionString = ""
          
          Import-Module BcContainerHelper -DisableNameChecking
          
          $baseFolder = $env:GITHUB_WORKSPACE
          $settingsFile = Join-Path $baseFolder ".AL-Go\settings.json"
          $settingsJson = Get-Content $settingsFile -Raw | ConvertFrom-Json
          
          # Ensure telemetry properties exist with empty strings
          if (-not $settingsJson.PSObject.Properties['MicrosoftTelemetryConnectionString']) {
            $settingsJson | Add-Member -MemberType NoteProperty -Name "MicrosoftTelemetryConnectionString" -Value ""
          }
          if (-not $settingsJson.PSObject.Properties['PartnerTelemetryConnectionString']) {
            $settingsJson | Add-Member -MemberType NoteProperty -Name "PartnerTelemetryConnectionString" -Value ""
          }
          
          $settings = $settingsJson
          
          # Create container
          $containerName = "bcserver"
          $password = ConvertTo-SecureString -String "P@ssw0rd" -AsPlainText -Force
          $credential = New-Object System.Management.Automation.PSCredential ("admin", $password)
          
          # Get country and version
          $country = $settings.country
          $artifact = Get-BCArtifactUrl -country $country -select Latest
          
          Write-Host "Creating container: $containerName"
          New-BcContainer `
            -accept_eula `
            -containerName $containerName `
            -credential $credential `
            -auth NavUserPassword `
            -artifactUrl $artifact `
            -includeAL `
            -doNotExportObjectsToText `
            -shortcuts Desktop `
            -updateHosts
          
          try {
            # Compile apps
            foreach ($appFolder in $settings.appFolders) {
              $appPath = Join-Path $baseFolder $appFolder
              Write-Host "Compiling app: $appFolder"
              Compile-AppInBcContainer `
                -containerName $containerName `
                -appProjectFolder $appPath `
                -credential $credential
            }
            
            # Run tests
            if (-not $settings.doNotRunTests -and $settings.testFolders.Count -gt 0) {
              foreach ($testFolder in $settings.testFolders) {
                $testPath = Join-Path $baseFolder $testFolder
                Write-Host "Running tests: $testFolder"
                Run-TestsInBcContainer `
                  -containerName $containerName `
                  -credential $credential `
                  -testSuite "DEFAULT" `
                  -appProjectFolder $testPath
              }
            }
            
            # Code analysis
            if ($settings.enableCodeCop) {
              Write-Host "Running CodeCop analysis"
            }
            
            if ($settings.enableAppSourceCop) {
              Write-Host "Running AppSourceCop analysis"
            }
            
            # Package apps
            if (-not $settings.doNotPublishApps) {
              foreach ($appFolder in $settings.appFolders) {
                $appPath = Join-Path $baseFolder $appFolder
                Write-Host "Packaging app: $appFolder"
                $appFile = Publish-BcContainerApp `
                  -containerName $containerName `
                  -appFile (Join-Path $appPath "*.app") `
                  -skipVerification `
                  -sync `
                  -install
                
                Write-Host "App packaged: $appFile"
              }
            }
            
            Write-Host "CI/CD pipeline completed successfully"
            Write-Host "Environment: $env:ENVIRONMENT"
          } finally {
            # Cleanup
            Remove-BcContainer -containerName $containerName
          }
