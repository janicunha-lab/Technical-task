name: CI/CD

on:
workflow_dispatch:
push:
branches:
- main
- develop
pull_request:
branches:
- main
- develop

jobs:
CI:
name: CI
runs-on: windows-latest
permissions:
contents: read
pull-requests: write
checks: write

steps:
  - name: Checkout repository
    uses: actions/checkout@v4
    with:
      fetch-depth: 0

  - name: Install BcContainerHelper
    shell: pwsh
    run: |
      Install-Module BcContainerHelper -Force -Scope CurrentUser -AllowClobber

  - name: Run CI/CD Pipeline
    shell: pwsh
    run: |
      $ErrorActionPreference = "Stop"

      # Import module
      Import-Module BcContainerHelper -DisableNameChecking -ErrorAction SilentlyContinue

      # Load settings
      $baseFolder = $env:GITHUB_WORKSPACE
      $settingsFile = Join-Path $baseFolder ".AL-Go\settings.json"
      $settings = Get-Content $settingsFile -Raw | ConvertFrom-Json

      # Container config
      $containerName = "bcserver"
      $password = ConvertTo-SecureString -String "P@ssw0rd" -AsPlainText -Force
      $credential = New-Object System.Management.Automation.PSCredential ("admin", $password)
      $artifact = Get-BCArtifactUrl -country $settings.country -select Latest
      $additionalParameters = @("--volume `"${baseFolder}:c:\source`"")

      Write-Host "Creating container: $containerName"
      New-BcContainer `
        -accept_eula `
        -containerName $containerName `
        -credential $credential `
        -auth NavUserPassword `
        -artifactUrl $artifact `
        -includeAL `
        -doNotExportObjectsToText `
        -shortcuts Desktop `
        -updateHosts `
        -includeTestToolkit:$true `
        -includeTestLibrariesOnly:$true `
        -additionalParameters $additionalParameters

      try {
        # Compile all apps
        foreach ($appFolder in $settings.appFolders) {
          $containerAppPath = "c:\source\$appFolder"
          Write-Host "Compiling app: $appFolder"
          Compile-AppInBcContainer -containerName $containerName -appProjectFolder $containerAppPath -credential $credential
        }

        # Run tests if enabled
        if ($settings.tests.runTests -and $settings.testFolders.Count -gt 0) {
          foreach ($testFolder in $settings.testFolders) {
            $containerTestPath = "c:\source\$testFolder"
            Write-Host "Running tests: $testFolder"
            Run-TestsInBcContainer `
              -containerName $containerName `
              -credential $credential `
              -testSuite "DEFAULT" `
              -appProjectFolder $containerTestPath `
              -testResultsFile $settings.tests.testResultsFile `
              -testResultsFormat $settings.tests.testResultsFormat
          }
        }

        # Run code analysis if enabled
        foreach ($appFolder in $settings.appFolders) {
          $containerAppPath = "c:\source\$appFolder"
          if ($settings.codeAnalysis.enableCodeCop) {
            Write-Host "Running CodeCop analysis for $appFolder"
            Test-ALCompiler -containerName $containerName -appProjectFolder $containerAppPath -credential $credential
          }
          if ($settings.codeAnalysis.enableAppSourceCop) {
            $appSourceCopJson = Join-Path $baseFolder $appFolder "AppSourceCop.json"
            if (Test-Path $appSourceCopJson) {
              Write-Host "Running AppSourceCop analysis for $appFolder"
              Test-AppSourceCop -containerName $containerName -appProjectFolder $containerAppPath -credential $credential
            }
          }
          if ($settings.codeAnalysis.enableUICop) {
            Write-Host "Running UICop analysis for $appFolder"
            Test-UICop -containerName $containerName -appProjectFolder $containerAppPath -credential $credential
          }
        }

        Write-Host "CI/CD pipeline completed successfully"
      } finally {
        # Cleanup container
        Remove-BcContainer -containerName $containerName
      }
