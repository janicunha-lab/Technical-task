name: CI/CD

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - 'Production'
          - 'Sandbox'
      directCommit:
        description: 'Direct commit (no PR)'
        required: false
        type: boolean
        default: false
  push:
    branches:
      - main

jobs:
  CI-CD:
    name: CI/CD
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      checks: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install BcContainerHelper
        shell: pwsh
        run: |
          Install-Module BcContainerHelper -Force -Scope CurrentUser -AllowClobber

      - name: Download AL-Go Helper Scripts
        shell: pwsh
        run: |
          $baseFolder = $env:GITHUB_WORKSPACE
          $alGoFolder = Join-Path $baseFolder ".github"
          New-Item -ItemType Directory -Force -Path $alGoFolder | Out-Null
          
          # Download AL-Go helper script
          $helperScript = Join-Path $alGoFolder "AL-Go-Helpers.ps1"
          Invoke-WebRequest -Uri "https://raw.githubusercontent.com/microsoft/AL-Go/main/.github/AL-Go-Helpers.ps1" -OutFile $helperScript

      - name: Run AL-Go CI/CD
        shell: pwsh
        env:
          ENVIRONMENT: ${{ github.event.inputs.environment }}
          DIRECTCOMMIT: ${{ github.event.inputs.directCommit }}
        run: |
          $ErrorActionPreference = "Stop"
          $baseFolder = $env:GITHUB_WORKSPACE
          
          # Import BcContainerHelper
          Import-Module BcContainerHelper -DisableNameChecking
          
          # Source AL-Go helper script
          $helperScript = Join-Path $baseFolder ".github\AL-Go-Helpers.ps1"
          if (Test-Path $helperScript) {
            . $helperScript
          }
          
          # Read settings
          $settings = Get-Content (Join-Path $baseFolder ".AL-Go\settings.json") | ConvertFrom-Json
          
          # Run pipeline
          if (Get-Command Run-AlPipeline -ErrorAction SilentlyContinue) {
            $params = @{
              baseFolder = $baseFolder
              type = "ci/cd"
              settings = $settings
            }
            if ($env:ENVIRONMENT) {
              $params.environment = $env:ENVIRONMENT
            }
            if ($env:DIRECTCOMMIT -eq "true") {
              $params.directCommit = $true
            }
            Run-AlPipeline @params
          } else {
            Write-Error "Run-AlPipeline function not found. Please check AL-Go helper script."
          }
