name: CI
on:
  workflow_dispatch:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  CI:
    runs-on: windows-latest
    permissions:
      contents: read
      pull-requests: write
      checks: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install BcContainerHelper
        shell: pwsh
        run: |
          Install-Module BcContainerHelper -Force -Scope CurrentUser -AllowClobber

      - name: Run CI Pipeline
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          Import-Module BcContainerHelper -DisableNameChecking -ErrorAction SilentlyContinue

          $baseFolder = $env:GITHUB_WORKSPACE
          $settingsFile = Join-Path $baseFolder ".AL-Go\settings.json"
          $settings = Get-Content $settingsFile -Raw | ConvertFrom-Json

          $containerName = "bcserver"
          $password = ConvertTo-SecureString -String "P@ssw0rd" -AsPlainText -Force
          $credential = New-Object System.Management.Automation.PSCredential ("admin", $password)
          $artifact = Get-BCArtifactUrl -country $settings.country -select Latest
          $additionalParameters = @("--volume `"${baseFolder}:c:\source`"")

          Write-Host "Creating container: $containerName"
          New-BcContainer `
            -accept_eula `
            -containerName $containerName `
            -credential $credential `
            -auth NavUserPassword `
            -artifactUrl $artifact `
            -includeAL `
            -doNotExportObjectsToText `
            -shortcuts Desktop `
            -updateHosts `
            -additionalParameters $additionalParameters

          try {
            foreach ($appFolder in $settings.appFolders) {
              $containerAppPath = "c:\source\$appFolder"
              Write-Host "Compiling app: $appFolder"
              Compile-AppInBcContainer -containerName $containerName -appProjectFolder $containerAppPath -credential $credential
            }

            if ($settings.doNotRunTests -eq $false -and $settings.testFolders.Count -gt 0) {
              foreach ($testFolder in $settings.testFolders) {
                $containerTestPath = "c:\source\$testFolder"
                Write-Host "Running tests: $testFolder"
                Run-TestsInBcContainer `
                  -containerName $containerName `
                  -credential $credential `
                  -testSuite "DEFAULT" `
                  -appProjectFolder $containerTestPath `
                  -testResultsFile $settings.testResultsFile `
                  -testResultsFormat $settings.testResultsFormat
              }
            }

            foreach ($appFolder in $settings.appFolders) {
              $containerAppPath = "c:\source\$appFolder"

              if ($settings.enableCodeCop) {
                Write-Host "Running CodeCop analysis for $appFolder"
                Test-ALCompiler -containerName $containerName -appProjectFolder $containerAppPath -credential $credential
              }

              if ($settings.enableAppSourceCop) {
                $appSourceCopJson = Join-Path $baseFolder $appFolder "AppSourceCop.json"
                if (Test-Path $appSourceCopJson) {
                  Write-Host "Running AppSourceCop analysis for $appFolder"
                  Test-AppSourceCop -containerName $containerName -appProjectFolder $containerAppPath -credential $credential
                }
              }

              if ($settings.enableUICop) {
                Write-Host "Running UICop analysis for $appFolder"
                Test-UICop -containerName $containerName -appProjectFolder $containerAppPath -credential $credential
              }
            }

            Write-Host "CI pipeline completed successfully"
          } finally {
            Remove-BcContainer -containerName $containerName
          }