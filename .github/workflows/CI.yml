name: CI

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  CI:
    name: CI
    runs-on: windows-latest
    permissions:
      contents: read
      pull-requests: write
      checks: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install BcContainerHelper
        shell: pwsh
        run: |
          Install-Module BcContainerHelper -Force -Scope CurrentUser -AllowClobber

      - name: Run CI Pipeline
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          
          # Import module (ignore telemetry warnings)
          $ErrorActionPreference = "Continue"
          Import-Module BcContainerHelper -DisableNameChecking -ErrorAction SilentlyContinue
          $ErrorActionPreference = "Stop"
          
          # Read settings
          $baseFolder = $env:GITHUB_WORKSPACE
          $settingsFile = Join-Path $baseFolder ".AL-Go\settings.json"
          $settings = Get-Content $settingsFile -Raw | ConvertFrom-Json
          
          # Create container
          $containerName = "bcserver"
          $password = ConvertTo-SecureString -String "P@ssw0rd" -AsPlainText -Force
          $credential = New-Object System.Management.Automation.PSCredential ("admin", $password)
          $country = $settings.country
          $artifact = Get-BCArtifactUrl -country $country -select Latest
          
          Write-Host "Creating container: $containerName"
          New-BcContainer `
            -accept_eula `
            -containerName $containerName `
            -credential $credential `
            -auth NavUserPassword `
            -artifactUrl $artifact `
            -includeAL `
            -doNotExportObjectsToText `
            -shortcuts Desktop `
            -updateHosts
          
          try {
            # Compile apps
            foreach ($appFolder in $settings.appFolders) {
              $appPath = Join-Path $baseFolder $appFolder
              Write-Host "Compiling app: $appFolder"
              Compile-AppInBcContainer `
                -containerName $containerName `
                -appProjectFolder $appPath `
                -credential $credential
            }
            
            # Run tests
            if (-not $settings.doNotRunTests -and $settings.testFolders.Count -gt 0) {
              foreach ($testFolder in $settings.testFolders) {
                $testPath = Join-Path $baseFolder $testFolder
                Write-Host "Running tests: $testFolder"
                Run-TestsInBcContainer `
                  -containerName $containerName `
                  -credential $credential `
                  -testSuite "DEFAULT" `
                  -appProjectFolder $testPath
              }
            }
            
            # Code analysis - CodeCop
            if ($settings.enableCodeCop) {
              Write-Host "Running CodeCop analysis"
              foreach ($appFolder in $settings.appFolders) {
                $appPath = Join-Path $baseFolder $appFolder
                $alcPath = Join-Path $appPath ".alpackages"
                if (-not (Test-Path $alcPath)) {
                  New-Item -ItemType Directory -Path $alcPath -Force | Out-Null
                }
                Test-ALCompiler -containerName $containerName -appProjectFolder $appPath -credential $credential
              }
            }
            
            # Code analysis - AppSourceCop
            if ($settings.enableAppSourceCop) {
              Write-Host "Running AppSourceCop analysis"
              foreach ($appFolder in $settings.appFolders) {
                $appPath = Join-Path $baseFolder $appFolder
                $appSourceCopJson = Join-Path $appPath "AppSourceCop.json"
                if (Test-Path $appSourceCopJson) {
                  Test-AppSourceCop -containerName $containerName -appProjectFolder $appPath -credential $credential
                }
              }
            }
            
            Write-Host "CI pipeline completed successfully"
          } finally {
            # Cleanup
            Remove-BcContainer -containerName $containerName
          }
