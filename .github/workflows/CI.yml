name: CI

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  CI:
    name: CI
    runs-on: windows-latest
    permissions:
      contents: read
      pull-requests: write
      checks: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install BcContainerHelper
        shell: pwsh
        run: |
          Install-Module BcContainerHelper -Force -Scope CurrentUser -AllowClobber

      - name: Run CI Pipeline
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          
          # Create BcContainerHelper config directory and file with telemetry properties
          $configPath = Join-Path $env:USERPROFILE ".BcContainerHelper"
          $configFile = Join-Path $configPath "BcContainerHelper.config.json"
          
          if (-not (Test-Path $configPath)) {
            New-Item -ItemType Directory -Path $configPath -Force | Out-Null
          }
          
          # Create or update config file with telemetry properties
          $config = @{
            MicrosoftTelemetryConnectionString = ""
            PartnerTelemetryConnectionString = ""
          }
          
          if (Test-Path $configFile) {
            $existingConfig = Get-Content $configFile -Raw | ConvertFrom-Json
            $existingConfig | Add-Member -MemberType NoteProperty -Name "MicrosoftTelemetryConnectionString" -Value "" -Force
            $existingConfig | Add-Member -MemberType NoteProperty -Name "PartnerTelemetryConnectionString" -Value "" -Force
            $config = $existingConfig
          }
          
          $config | ConvertTo-Json -Depth 10 | Set-Content $configFile -Force
          
          # Also set environment variables
          $env:MicrosoftTelemetryConnectionString = ""
          $env:PartnerTelemetryConnectionString = ""
          
          # Now import the module
          Import-Module BcContainerHelper -DisableNameChecking
          
          $baseFolder = $env:GITHUB_WORKSPACE
          $settingsFile = Join-Path $baseFolder ".AL-Go\settings.json"
          $settingsJson = Get-Content $settingsFile -Raw | ConvertFrom-Json
          
          # Ensure telemetry properties exist with empty strings
          if (-not $settingsJson.PSObject.Properties['MicrosoftTelemetryConnectionString']) {
            $settingsJson | Add-Member -MemberType NoteProperty -Name "MicrosoftTelemetryConnectionString" -Value ""
          } else {
            $settingsJson.MicrosoftTelemetryConnectionString = ""
          }
          if (-not $settingsJson.PSObject.Properties['PartnerTelemetryConnectionString']) {
            $settingsJson | Add-Member -MemberType NoteProperty -Name "PartnerTelemetryConnectionString" -Value ""
          } else {
            $settingsJson.PartnerTelemetryConnectionString = ""
          }
          
          $settings = $settingsJson
          
          # Create container
          $containerName = "bcserver"
          $password = ConvertTo-SecureString -String "P@ssw0rd" -AsPlainText -Force
          $credential = New-Object System.Management.Automation.PSCredential ("admin", $password)
          
          $bcContainerHelperConfig = @{
            "bcContainerHelperVersion" = $settings.bcContainerHelperVersion
          }
          
          # Get country and version
          $country = $settings.country
          $artifact = Get-BCArtifactUrl -country $country -select Latest
          
          Write-Host "Creating container: $containerName"
          New-BcContainer `
            -accept_eula `
            -containerName $containerName `
            -credential $credential `
            -auth NavUserPassword `
            -artifactUrl $artifact `
            -includeAL `
            -doNotExportObjectsToText `
            -shortcuts Desktop `
            -updateHosts
          
          try {
            # Compile apps
            foreach ($appFolder in $settings.appFolders) {
              $appPath = Join-Path $baseFolder $appFolder
              Write-Host "Compiling app: $appFolder"
              Compile-AppInBcContainer `
                -containerName $containerName `
                -appProjectFolder $appPath `
                -credential $credential
            }
            
            # Run tests
            if (-not $settings.doNotRunTests -and $settings.testFolders.Count -gt 0) {
              foreach ($testFolder in $settings.testFolders) {
                $testPath = Join-Path $baseFolder $testFolder
                Write-Host "Running tests: $testFolder"
                Run-TestsInBcContainer `
                  -containerName $containerName `
                  -credential $credential `
                  -testSuite "DEFAULT" `
                  -appProjectFolder $testPath
              }
            }
            
            # Code analysis
            if ($settings.enableCodeCop) {
              Write-Host "Running CodeCop analysis"
              # CodeCop analysis would go here
            }
            
            if ($settings.enableAppSourceCop) {
              Write-Host "Running AppSourceCop analysis"
              # AppSourceCop analysis would go here
            }
            
            Write-Host "CI pipeline completed successfully"
          } finally {
            # Cleanup
            Remove-BcContainer -containerName $containerName
          }
